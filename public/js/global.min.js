function _onBeforeNavigate(e){requestURL=e.url}function _onNavigate(e){requestURL.indexOf("https://www.facebook.com/dialog/return/close")>-1||requestURL.indexOf("https://twitter.com/intent/tweet/complete")>-1||(currentScriptURL.length>0&&(safari.extension.removeContentScript(currentScriptURL),currentScriptURL=""),$.ajax({url:requestURL,type:"get",error:function(e,t){handleReadyState(e.readyState,e.status)}}))}function _onRecentVersion(){wmAvailabilityCheck(getOriginalURL(safari.application.activeBrowserWindow.activeTab.url),null,function(e,t){safari.application.activeBrowserWindow.activeTab.url=e})}function _onFirstVersion(){wmAvailabilityCheck(getOriginalURL(safari.application.activeBrowserWindow.activeTab.url),"00000000000000",function(e,t){safari.application.activeBrowserWindow.activeTab.url=e})}function handleReadyState(e,t){if(4==e&&httpFailCodes.indexOf(t)>=0&&isValidUrl(requestURL)||0==e&&0==t){var a=new URL(requestURL);a?["http://*","https://*",a.protocol+"//"+a.host+"*"]:[requestURL],wmAvailabilityCheck(requestURL,null,function(e,t){safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("SHOW_BANNER",{wayback_url:e})})}}function wmAvailabilityCheck(e,t,a,s){var i=new XMLHttpRequest,r=WB_API_URL,n="url="+encodeURI(e);null!=t&&(n+="&&timestamp="+t),i.open("POST",r,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.setRequestHeader("User-Agent","Wayback_Machine_Safari_EB/"+safari.extension.displayVersion),i.setRequestHeader("Wayback-Extension-Version","Wayback_Machine_Safari_EB/"+safari.extension.displayVersion),i.setRequestHeader("Wayback-Api-Version",2),i.onload=function(){var t=JSON.parse(i.responseText),r=getWaybackUrlFromResponse(t);null!==r?a(r,e):s&&s()},i.send(n)}function getWaybackUrlFromResponse(e){return e.results&&e.results[0]&&e.results[0].archived_snapshots&&e.results[0].archived_snapshots.closest&&e.results[0].archived_snapshots.closest.available&&!0===e.results[0].archived_snapshots.closest.available&&0===e.results[0].archived_snapshots.closest.status.indexOf("2")&&isValidSnapshotUrl(e.results[0].archived_snapshots.closest.url)?makeHttps(e.results[0].archived_snapshots.closest.url):null}function isValidUrl(e){for(var t=0;t<excluded_urls.length;t++)if(e.startsWith("http://"+excluded_urls[t])||e.startsWith("https://"+excluded_urls[t]))return!1;return!0}function isValidSnapshotUrl(e){return"string"==typeof e&&(0===e.indexOf("http://")||0===e.indexOf("https://"))}function makeHttps(e){return e.replace(/^http:/,"https:")}function setExtensionIcon(e){for(var t=safari.extension.baseURI+"../../public/img/"+e,a=0;a<safari.extension.toolbarItems.length;a++)safari.extension.toolbarItems[a].image=t}function getOriginalURL(e){return(e.match(/http/g)||[]).length>1?e.substr(e.lastIndexOf("http")):e}var httpFailCodes=[404,408,410,451,500,502,503,504,509,520,521,523,524,525,526],WB_API_URL="https://archive.org/wayback/available",excluded_urls=["web.archive.org/web/","localhost","0.0.0.0","127.0.0.1"],requestURL="",currentScriptURL="";$(document).ready(function(){safari.application.addEventListener("beforeNavigate",_onBeforeNavigate,!0),safari.application.addEventListener("navigate",_onNavigate,!0)});